import _extends from "@babel/runtime/helpers/extends";
import _slicedToArray from "@babel/runtime/helpers/slicedToArray";
import _objectWithoutProperties from "@babel/runtime/helpers/objectWithoutProperties";
import { createScopedElement } from "../../lib/jsxRuntime";
import { useState, useRef, useEffect, useContext, Fragment } from 'react';
import { classNames } from "../../lib/classNames";
import { getClassName } from "../../helpers/getClassName";
import Touch from "../Touch/Touch";
import { ANDROID, IOS, VKCOM } from "../../lib/platform";
import { Icon24Reorder, Icon24ReorderIos, Icon24CheckCircleOn, Icon24CheckCircleOff } from '@vkontakte/icons';
import SimpleCell from "../SimpleCell/SimpleCell";
import { Removable } from "../Removable/Removable";
import { usePlatform } from "../../hooks/usePlatform";
import { ListContext } from "../../components/List/ListContext";
export var Cell = function Cell(props) {
  var _onRemove = props.onRemove,
      removePlaceholder = props.removePlaceholder,
      onDragFinish = props.onDragFinish,
      className = props.className,
      style = props.style,
      before = props.before,
      after = props.after,
      disabled = props.disabled,
      removable = props.removable,
      draggable = props.draggable,
      selectable = props.selectable,
      Component = props.Component,
      onChange = props.onChange,
      name = props.name,
      checked = props.checked,
      defaultChecked = props.defaultChecked,
      getRootRef = props.getRootRef,
      restProps = _objectWithoutProperties(props, ["onRemove", "removePlaceholder", "onDragFinish", "className", "style", "before", "after", "disabled", "removable", "draggable", "selectable", "Component", "onChange", "name", "checked", "defaultChecked", "getRootRef"]);

  var rootElRef = useRef(null);
  var platform = usePlatform();

  var _useState = useState(false),
      _useState2 = _slicedToArray(_useState, 2),
      dragging = _useState2[0],
      setDragging = _useState2[1];

  var _useState3 = useState(undefined),
      _useState4 = _slicedToArray(_useState3, 2),
      siblings = _useState4[0],
      setSiblings = _useState4[1];

  var _useState5 = useState(undefined),
      _useState6 = _slicedToArray(_useState5, 2),
      dragStartIndex = _useState6[0],
      setDragStartIndex = _useState6[1];

  var _useState7 = useState(undefined),
      _useState8 = _slicedToArray(_useState7, 2),
      dragEndIndex = _useState8[0],
      setDragEndIndex = _useState8[1];

  var _useState9 = useState(0),
      _useState10 = _slicedToArray(_useState9, 2),
      dragShift = _useState10[0],
      setDragShift = _useState10[1];

  var _useState11 = useState(undefined),
      _useState12 = _slicedToArray(_useState11, 2),
      dragDirection = _useState12[0],
      setDragDirection = _useState12[1];

  var onDragStart = function onDragStart() {
    var rootEl = rootElRef === null || rootElRef === void 0 ? void 0 : rootElRef.current;
    setDragging(true);

    var _siblings = Array.from(rootEl.parentElement.childNodes);

    setDragStartIndex(_siblings.indexOf(rootEl));
    setSiblings(_siblings);
    setDragShift(0);
  };

  var onDragMove = function onDragMove(e) {
    e.originalEvent.preventDefault();
    var rootEl = rootElRef === null || rootElRef === void 0 ? void 0 : rootElRef.current;
    rootEl.style.transform = "translateY(".concat(e.shiftY, "px)");
    setDragDirection(dragShift - e.shiftY < 0 ? 'down' : 'up');
    setDragShift(e.shiftY);
    setDragEndIndex(dragStartIndex);
    siblings.forEach(function (sibling, siblingIndex) {
      var rootGesture = rootEl.getBoundingClientRect();
      var siblingGesture = sibling.getBoundingClientRect();

      if (dragStartIndex < siblingIndex) {
        if (rootGesture.bottom > siblingGesture.top + siblingGesture.height / 2) {
          if (dragDirection === 'down') {
            sibling.style.transform = 'translateY(-100%)';
          }

          setDragEndIndex(function (dragEndIndex) {
            return dragEndIndex + 1;
          });
        }

        if (rootGesture.top < siblingGesture.bottom - siblingGesture.height / 2 && dragDirection === 'up') {
          sibling.style.transform = 'translateY(0)';
        }
      } else if (dragStartIndex > siblingIndex) {
        if (rootGesture.top < siblingGesture.bottom - siblingGesture.height / 2) {
          if (dragDirection === 'up') {
            sibling.style.transform = 'translateY(100%)';
          }

          setDragEndIndex(function (dragEndIndex) {
            return dragEndIndex - 1;
          });
        }

        if (rootGesture.bottom > siblingGesture.top + siblingGesture.height / 2 && dragDirection === 'down') {
          sibling.style.transform = 'translateY(0)';
        }
      }
    });
  };

  var onDragEnd = function onDragEnd() {
    var from = dragStartIndex,
        to = dragEndIndex;
    siblings.forEach(function (sibling) {
      sibling.style.transform = null;
    });
    setSiblings(undefined);
    setDragEndIndex(undefined);
    setDragStartIndex(undefined);
    setDragDirection(undefined);
    setDragShift(undefined);
    setDragging(false);
    props.onDragFinish && props.onDragFinish({
      from: from,
      to: to
    });
  };

  var onDragClick = function onDragClick(e) {
    e.nativeEvent.stopPropagation();
    e.preventDefault();
  };

  var _useContext = useContext(ListContext),
      toggleDrag = _useContext.toggleDrag;

  useEffect(function () {
    if (dragging) {
      toggleDrag(true);
      return function () {
        return toggleDrag(false);
      };
    }

    return undefined;
  }, [dragging]);
  var simpleCell = createScopedElement(SimpleCell, _extends({}, restProps, {
    disabled: draggable || removable || disabled,
    Component: selectable ? 'label' : Component,
    htmlFor: selectable ? name : undefined,
    before: createScopedElement(Fragment, null, (platform === ANDROID || platform === VKCOM) && draggable && createScopedElement(Touch, {
      vkuiClass: "Cell__dragger",
      onStart: onDragStart,
      onMoveY: onDragMove,
      onEnd: onDragEnd,
      onClick: onDragClick
    }, createScopedElement(Icon24Reorder, null)), selectable && createScopedElement(Fragment, null, createScopedElement("input", {
      type: "checkbox",
      vkuiClass: "Cell__checkbox",
      name: name,
      onChange: onChange,
      defaultChecked: defaultChecked,
      checked: checked,
      disabled: disabled
    }), createScopedElement("span", {
      vkuiClass: "Cell__marker"
    }, createScopedElement(Icon24CheckCircleOff, {
      vkuiClass: "Cell__marker-in"
    }), createScopedElement(Icon24CheckCircleOn, {
      vkuiClass: "Cell__marker-in Cell__marker-in--checked"
    }))), before),
    after: createScopedElement(Fragment, null, platform === IOS && draggable && createScopedElement(Touch, {
      vkuiClass: "Cell__dragger",
      onStart: onDragStart,
      onMoveY: onDragMove,
      onEnd: onDragEnd,
      onClick: onDragClick
    }, createScopedElement(Icon24ReorderIos, null)), after)
  }));
  return createScopedElement("div", {
    vkuiClass: classNames(getClassName('Cell', platform), {
      'Cell--dragging': dragging,
      'Cell--removable': removable,
      'Cell--selectable': selectable,
      'Cell--disabled': disabled
    }),
    className: className,
    style: style,
    ref: rootElRef
  }, removable ? createScopedElement(Removable, {
    removePlaceholder: removePlaceholder,
    onRemove: function onRemove(e) {
      return _onRemove(e, rootElRef === null || rootElRef === void 0 ? void 0 : rootElRef.current);
    }
  }, simpleCell) : simpleCell);
};
Cell.defaultProps = {
  removePlaceholder: 'Удалить'
};
//# sourceMappingURL=Cell.js.map