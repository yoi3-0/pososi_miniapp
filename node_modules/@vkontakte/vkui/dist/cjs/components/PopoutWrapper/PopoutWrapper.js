"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard").default;

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _jsxRuntime = require("../../lib/jsxRuntime");

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _createSuper2 = _interopRequireDefault(require("@babel/runtime/helpers/createSuper"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _getClassName = require("../../helpers/getClassName");

var _classNames = require("../../lib/classNames");

var _platform = require("../../lib/platform");

var _supportEvents = require("../../lib/supportEvents");

var _withPlatform = require("../../hoc/withPlatform");

var _dom = require("../../lib/dom");

var PopoutWrapper = /*#__PURE__*/function (_Component) {
  (0, _inherits2.default)(PopoutWrapper, _Component);

  var _super = (0, _createSuper2.default)(PopoutWrapper);

  function PopoutWrapper(props) {
    var _this;

    (0, _classCallCheck2.default)(this, PopoutWrapper);
    _this = _super.call(this, props);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "elRef", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "animationFinishTimeout", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "onFadeInEnd", function (e) {
      if (!e || e.animationName === 'vkui-animation-full-fade-in') {
        _this.setState({
          opened: true
        });
      }
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)(_this), "preventTouch", function (e) {
      return e.preventDefault();
    });
    _this.state = {
      opened: !props.hasMask
    };
    _this.elRef = /*#__PURE__*/_react.default.createRef();
    return _this;
  }

  (0, _createClass2.default)(PopoutWrapper, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      if (_dom.canUseDOM) {
        this.props.window.addEventListener('touchmove', this.preventTouch, {
          passive: false
        });
        this.waitAnimationFinish(this.elRef.current, this.onFadeInEnd);
      }
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      // Здесь нужен последний аргумент с такими же параметрами, потому что
      // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.
      // https://github.com/VKCOM/VKUI/issues/444
      if (_dom.canUseDOM) {
        // @ts-ignore (В интерфейсе EventListenerOptions нет поля passive)
        this.props.window.removeEventListener('touchmove', this.preventTouch, {
          passive: false
        });
        clearTimeout(this.animationFinishTimeout);
      }
    }
  }, {
    key: "waitAnimationFinish",
    value: function waitAnimationFinish(elem, eventHandler) {
      if (_supportEvents.animationEvent.supported) {
        elem.removeEventListener(_supportEvents.animationEvent.name, eventHandler);
        elem.addEventListener(_supportEvents.animationEvent.name, eventHandler);
      } else {
        clearTimeout(this.animationFinishTimeout);
        this.animationFinishTimeout = setTimeout(eventHandler, this.props.platform === _platform.ANDROID || this.props.platform === _platform.VKCOM ? 200 : 300);
      }
    }
  }, {
    key: "render",
    value: function render() {
      var _this$props = this.props,
          alignY = _this$props.alignY,
          alignX = _this$props.alignX,
          closing = _this$props.closing,
          children = _this$props.children,
          hasMask = _this$props.hasMask,
          fixed = _this$props.fixed,
          platform = _this$props.platform,
          onClick = _this$props.onClick,
          window = _this$props.window,
          document = _this$props.document,
          restProps = (0, _objectWithoutProperties2.default)(_this$props, ["alignY", "alignX", "closing", "children", "hasMask", "fixed", "platform", "onClick", "window", "document"]);
      var baseClassNames = (0, _getClassName.getClassName)('PopoutWrapper', platform);
      return (0, _jsxRuntime.createScopedElement)("div", (0, _extends2.default)({}, restProps, {
        vkuiClass: (0, _classNames.classNames)(baseClassNames, "PopoutWrapper--v-".concat(alignY), "PopoutWrapper--h-".concat(alignX), {
          'PopoutWrapper--closing': closing,
          'PopoutWrapper--opened': this.state.opened,
          'PopoutWrapper--fixed': fixed,
          'PopoutWrapper--masked': hasMask
        }),
        ref: this.elRef
      }), (0, _jsxRuntime.createScopedElement)("div", {
        vkuiClass: "PopoutWrapper__container"
      }, (0, _jsxRuntime.createScopedElement)("div", {
        vkuiClass: "PopoutWrapper__overlay",
        onClick: onClick
      }), (0, _jsxRuntime.createScopedElement)("div", {
        vkuiClass: "PopoutWrapper__content"
      }, children)));
    }
  }]);
  return PopoutWrapper;
}(_react.Component);

(0, _defineProperty2.default)(PopoutWrapper, "defaultProps", {
  hasMask: true,
  fixed: true,
  alignY: 'center',
  alignX: 'center',
  closing: false
});

var _default = (0, _withPlatform.withPlatform)((0, _dom.withDOM)(PopoutWrapper));

exports.default = _default;
//# sourceMappingURL=PopoutWrapper.js.map