{"version":3,"sources":["../../../../src/components/ModalRoot/ModalRootDesktop.tsx"],"names":["warn","IS_DEV","process","env","NODE_ENV","ModalRootDesktopComponent","props","e","key","triggerActiveModalClose","document","removeEventListener","handleKeyDownEsc","activeTransitions","Math","max","activeModal","state","nextModal","newState","prevModal","visibleModals","animated","switching","history","setState","activeModalState","modalsState","doCloseModal","modalState","onClose","id","isBack","inited","maskElementRef","React","createRef","initModalsState","modalRootContext","updateModalHeight","undefined","registerModal","data","Object","assign","isInsideModal","modals","reduce","acc","Modal","modalProps","dynamicContentHeight","settlingHeight","initActiveModal","addEventListener","prevProps","prevState","includes","splice","indexOf","push","closeActiveModal","requestAnimationFrame","switchPrevNext","type","ModalType","PAGE","CARD","prevModalState","waitTransitionFinish","prevNextSwitchEndHandler","animateModalOpacity","setMaskOpacity","eventHandler","transitionEvent","supported","onceHandler","innerElement","name","setTimeout","platform","ANDROID","VKCOM","nextModalState","prevIsCard","nextIsPage","nextIsCard","display","style","opacity","forceOpacity","cancelAnimationFrame","maskAnimationFrame","current","translateY","translateYCurrent","min","toString","configProvider","webviewType","WebviewType","VKAPPS","map","modalId","window","Children","toArray","children","Component","ModalRootDesktop","ConfigProviderContext"],"mappings":"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","sourcesContent":["import React, { Children, Component, ReactElement } from 'react';\nimport { classNames } from '../../lib/classNames';\nimport { isFunction } from '../../lib/utils';\nimport { transitionEvent } from '../../lib/supportEvents';\nimport { HasPlatform } from '../../types';\nimport { withPlatform } from '../../hoc/withPlatform';\nimport { withContext } from '../../hoc/withContext';\nimport ModalRootContext, { ModalRootContextInterface } from './ModalRootContext';\nimport {\n  ConfigProviderContext,\n  ConfigProviderContextInterface,\n  WebviewType,\n} from '../ConfigProvider/ConfigProviderContext';\nimport { ModalsStateEntry, ModalType } from './types';\nimport { ANDROID, VKCOM } from '../../lib/platform';\nimport { getClassName } from '../../helpers/getClassName';\nimport { DOMProps, withDOM } from '../../lib/dom';\nimport { getNavId } from '../../lib/getNavId';\nimport { warnOnce } from '../../lib/warnOnce';\n\nconst warn = warnOnce('ModalRoot');\nconst IS_DEV = process.env.NODE_ENV === 'development';\n\nexport interface ModalRootProps extends HasPlatform {\n  activeModal?: string | null;\n  /**\n   * @ignore\n   */\n  configProvider?: ConfigProviderContextInterface;\n\n  /**\n   * Будет вызвано при закрытии активной модалки с её id\n   */\n  onClose?(modalId: string): void;\n}\n\ninterface ModalRootState {\n  activeModal?: string;\n  prevModal?: string;\n  nextModal?: string;\n  visibleModals?: string[];\n  animated?: boolean;\n  switching?: boolean;\n  history?: string[];\n  isBack?: boolean;\n  inited?: boolean;\n}\n\nclass ModalRootDesktopComponent extends Component<ModalRootProps & DOMProps, ModalRootState> {\n  constructor(props: ModalRootProps) {\n    super(props);\n\n    const activeModal = props.activeModal;\n\n    this.state = {\n      activeModal: null,\n      prevModal: null,\n      nextModal: activeModal,\n      visibleModals: activeModal ? [activeModal] : [],\n      animated: !!activeModal,\n      switching: false,\n      history: activeModal ? [activeModal] : [],\n      isBack: false,\n      inited: false,\n    };\n\n    this.maskElementRef = React.createRef();\n    this.activeTransitions = 0;\n\n    this.initModalsState();\n\n    this.modalRootContext = {\n      updateModalHeight: () => undefined,\n      registerModal: ({ id, ...data }) => Object.assign(this.modalsState[id], data),\n      onClose: this.triggerActiveModalClose,\n      isInsideModal: true,\n    };\n  }\n\n  private modalsState: { [id: string]: ModalsStateEntry };\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private maskAnimationFrame: number;\n  private readonly modalRootContext: ModalRootContextInterface;\n\n  activeTransitions: number;\n\n  get document(): Document {\n    return this.props.document;\n  }\n\n  get window(): Window {\n    return this.props.window;\n  }\n\n  get modals() {\n    return Children.toArray(this.props.children) as ReactElement[];\n  }\n\n  initModalsState() {\n    this.modalsState = this.modals.reduce<{ [id: string]: ModalsStateEntry }>((acc, Modal) => {\n      const modalProps = Modal.props;\n      const state: ModalsStateEntry = {\n        id: getNavId(Modal.props, warn),\n        onClose: Modal.props.onClose,\n        dynamicContentHeight: !!modalProps.dynamicContentHeight,\n      };\n\n      // ModalPage props\n      if (typeof modalProps.settlingHeight === 'number') {\n        state.settlingHeight = modalProps.settlingHeight;\n      }\n\n      acc[state.id] = state;\n      return acc;\n    }, {});\n  }\n\n  handleKeyDownEsc = (e: KeyboardEvent): void => {\n    if (e.key === 'Escape') {\n      this.triggerActiveModalClose();\n    }\n  };\n\n  componentDidMount() {\n    this.initActiveModal();\n    document.addEventListener('keydown', this.handleKeyDownEsc);\n  }\n\n  componentWillUnmount = () => {\n    document.removeEventListener('keydown', this.handleKeyDownEsc);\n  };\n\n  componentDidUpdate(prevProps: ModalRootProps, prevState: ModalRootState) {\n    if (this.props.activeModal !== prevProps.activeModal) {\n      const nextModal = this.props.activeModal;\n      const prevModal = prevProps.activeModal;\n\n      if (IS_DEV && nextModal !== null && !this.modalsState[nextModal]) {\n        return warn(`[ModalRoot.componentDidUpdate] nextModal ${nextModal} not found`);\n      }\n\n      let history = [...this.state.history];\n      let isBack = false;\n\n      if (nextModal === null) {\n        history = [];\n      } else if (history.includes(nextModal)) {\n        history = history.splice(0, history.indexOf(nextModal) + 1);\n        isBack = true;\n      } else {\n        history.push(nextModal);\n      }\n\n      return this.setState({\n        activeModal: null,\n        nextModal,\n        prevModal,\n        visibleModals: [nextModal, prevModal],\n        history,\n        isBack,\n        animated: true,\n        inited: false,\n        switching: false,\n      }, () => {\n        if (nextModal === null) {\n          this.closeActiveModal();\n        } else {\n          this.initActiveModal();\n        }\n      });\n    }\n\n    if (this.state.switching && !prevState.switching) {\n      requestAnimationFrame(() => this.switchPrevNext());\n    }\n  }\n\n  /**\n   * Инициализирует модалку перед анимацией открытия\n   */\n  initActiveModal() {\n    const activeModal = this.state.activeModal || this.state.nextModal;\n    if (!activeModal) {\n      return;\n    }\n\n    const modalState = this.modalsState[activeModal];\n\n    switch (modalState.type) {\n      case ModalType.PAGE:\n        modalState.settlingHeight = modalState.settlingHeight || 75;\n        break;\n\n      case ModalType.CARD:\n        break;\n\n      default:\n        if (IS_DEV) {\n          warn('[initActiveModal] modalState.type is unknown');\n        }\n    }\n\n    this.setState({ inited: true, switching: true });\n  }\n\n  closeActiveModal() {\n    const { prevModal } = this.state;\n    if (IS_DEV && !prevModal) {\n      return warn(`[closeActiveModal] prevModal is ${prevModal}`);\n    }\n\n    const prevModalState = this.modalsState[prevModal];\n\n    this.waitTransitionFinish(prevModalState, this.prevNextSwitchEndHandler);\n    this.animateModalOpacity(prevModalState, false);\n    this.setMaskOpacity(prevModalState, 0);\n  }\n\n  waitTransitionFinish(modalState: ModalsStateEntry, eventHandler: () => void) {\n    if (transitionEvent.supported) {\n      const onceHandler = () => {\n        modalState.innerElement.removeEventListener(transitionEvent.name, onceHandler);\n        eventHandler();\n      };\n\n      modalState.innerElement.addEventListener(transitionEvent.name, onceHandler);\n    } else {\n      setTimeout(eventHandler, this.props.platform === ANDROID || this.props.platform === VKCOM ? 320 : 400);\n    }\n  }\n\n  switchPrevNext() {\n    const { prevModal, nextModal } = this.state;\n\n    const prevModalState = this.modalsState[prevModal];\n    const nextModalState = this.modalsState[nextModal];\n\n    if (IS_DEV && !prevModalState && !nextModalState) {\n      return warn(`[switchPrevNext] prevModal is ${prevModal}, nextModal is ${nextModal}`);\n    }\n\n    const prevIsCard = !!prevModalState && prevModalState.type === ModalType.CARD;\n\n    const nextIsPage = !!nextModalState && nextModalState.type === ModalType.PAGE;\n    const nextIsCard = !!nextModalState && nextModalState.type === ModalType.CARD;\n\n    // Ждём полного скрытия предыдущей модалки\n    if (prevModalState && (nextIsCard || prevIsCard && nextIsPage)) {\n      this.activeTransitions += 1;\n      this.waitTransitionFinish(prevModalState, () => {\n        this.waitTransitionFinish(nextModalState, this.prevNextSwitchEndHandler);\n        this.animateModalOpacity(nextModalState, true);\n      });\n\n      requestAnimationFrame(() => {\n        this.animateModalOpacity(prevModalState, false);\n      });\n\n      return;\n    }\n\n    if (prevModalState && nextIsPage) {\n      this.activeTransitions += 1;\n      this.waitTransitionFinish(prevModalState, this.prevNextSwitchEndHandler);\n      requestAnimationFrame(() => {\n        this.animateModalOpacity(prevModalState, false);\n      });\n    }\n\n    this.activeTransitions += 1;\n    this.waitTransitionFinish(nextModalState, this.prevNextSwitchEndHandler);\n    requestAnimationFrame(() => {\n      this.animateModalOpacity(nextModalState, true);\n    });\n  }\n\n  prevNextSwitchEndHandler = () => {\n    this.activeTransitions = Math.max(0, this.activeTransitions - 1);\n    if (this.activeTransitions > 0) {\n      return;\n    }\n\n    const activeModal = this.state.nextModal;\n\n    const newState: ModalRootState = {\n      prevModal: null,\n      nextModal: null,\n      visibleModals: [activeModal],\n      activeModal: activeModal,\n      animated: false,\n      switching: false,\n    };\n\n    if (!activeModal) {\n      newState.history = [];\n    }\n\n    this.setState(newState);\n  };\n\n  /* Анимирует сдивг модалки */\n  animateModalOpacity(modalState: ModalsStateEntry, display: boolean) {\n    modalState.innerElement.style.opacity = display ? '1' : '0';\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(modalState: ModalsStateEntry, forceOpacity: number = null) {\n    if (forceOpacity === null && this.state.history[0] !== modalState.id) {\n      return;\n    }\n\n    cancelAnimationFrame(this.maskAnimationFrame);\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY, translateYCurrent } = modalState;\n\n        const opacity = forceOpacity === null ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0 : forceOpacity;\n        this.maskElementRef.current.style.opacity = Math.max(0, Math.min(100, opacity)).toString();\n      }\n    });\n  }\n\n  /**\n   * Закрывает текущую модалку\n   */\n  triggerActiveModalClose = () => {\n    const activeModalState = this.modalsState[this.state.activeModal];\n    if (activeModalState) {\n      this.doCloseModal(activeModalState);\n    }\n  };\n\n  private readonly doCloseModal = (modalState: ModalsStateEntry) => {\n    if (isFunction(modalState.onClose)) {\n      modalState.onClose();\n    } else if (isFunction(this.props.onClose)) {\n      this.props.onClose(modalState.id);\n    } else if (IS_DEV) {\n      warn('onClose is undefined');\n    }\n  };\n\n  render() {\n    const { prevModal, activeModal, nextModal, visibleModals, animated } = this.state;\n\n    if (!activeModal && !prevModal && !nextModal && !animated) {\n      return null;\n    }\n\n    return (\n      <ModalRootContext.Provider value={this.modalRootContext}>\n        <div\n          vkuiClass={classNames(getClassName('ModalRoot', this.props.platform), {\n            'ModalRoot--vkapps': this.props.configProvider.webviewType === WebviewType.VKAPPS,\n          }, 'ModalRoot--desktop')}\n        >\n          <div\n            vkuiClass=\"ModalRoot__mask\"\n            onClick={this.triggerActiveModalClose}\n            ref={this.maskElementRef}\n          />\n          <div vkuiClass=\"ModalRoot__viewport\">\n            {this.modals.map((Modal: ReactElement) => {\n              const modalId = getNavId(Modal.props, warn);\n              if (!visibleModals.includes(modalId)) {\n                return null;\n              }\n\n              const key = `modal-${modalId}`;\n\n              return (\n                <div\n                  key={key}\n                  vkuiClass={classNames('ModalRoot__modal', {\n                    'ModalRoot__modal--active': modalId === activeModal,\n                    'ModalRoot__modal--prev': modalId === prevModal,\n                    'ModalRoot__modal--next': modalId === nextModal,\n                  })}\n                >{Modal}</div>\n              );\n            })}\n          </div>\n        </div>\n      </ModalRootContext.Provider>\n    );\n  }\n}\n\nexport const ModalRootDesktop = withContext(withPlatform(withDOM<ModalRootProps>(ModalRootDesktopComponent)), ConfigProviderContext, 'configProvider');\n"],"file":"ModalRootDesktop.js"}