{"version":3,"file":"index.js","sources":["../src/promisifySend.ts","../src/bridge.ts","../src/custom-event.ts","../src/applyMiddleware.ts","../src/index.ts"],"sourcesContent":["import {\n  VKBridgeSubscribeHandler,\n  AnyRequestMethodName,\n  RequestProps,\n  RequestIdProp,\n  ReceiveData,\n  AnyReceiveMethodName,\n} from './types/bridge';\n\n/**\n * Creates counter interface.\n */\nfunction createCounter() {\n  return {\n    current: 0,\n    next() {\n      return ++this.current;\n    },\n  };\n}\n\n/**\n * Creates interface for resolving request promises by request id's (or not).\n */\nfunction createRequestResolver() {\n  /**\n   * @prop resolve Resolve function.\n   * @prop reject Reject function.\n   */\n  type PromiseController = {\n    resolve: (value: any) => any;\n    reject: (reason: any) => any;\n  };\n\n  const counter = createCounter();\n  const promiseControllers: Record<number | string, PromiseController | null> = {};\n\n  return {\n    /**\n     * Adds new controller with resolve/reject methods.\n     *\n     * @param controller Object with `resolve` and `reject` functions\n     * @param customId Custom `request_id`\n     * @returns New request id of the added controller.\n     */\n    add(controller: PromiseController, customId?: number | string): number | string {\n      const id = customId != null ? customId : counter.next();\n\n      promiseControllers[id] = controller;\n\n      return id;\n    },\n\n    /**\n     * Resolves/rejects an added promise by request id and the `isSuccess`\n     * predicate.\n     *\n     * @param requestId Request ID.\n     * @param data Data to pass to the resolve- or reject-function.\n     * @param isSuccess Predicate to select the desired function.\n     */\n    resolve<T>(requestId: number | string, data: T, isSuccess: (data: T) => boolean) {\n      const requestPromise = promiseControllers[requestId];\n\n      if (requestPromise) {\n        if (isSuccess(data)) {\n          requestPromise.resolve(data);\n        } else {\n          requestPromise.reject(data);\n        }\n\n        promiseControllers[requestId] = null;\n      }\n    },\n  };\n}\n\n/**\n * Returns send function that returns promises.\n *\n * @param sendEvent Send event function.\n * @param subscribe Subscribe event function.\n * @returns Send function which returns the Promise object.\n */\nexport function promisifySend(\n  sendEvent: <K extends AnyRequestMethodName>(method: K, props?: RequestProps<K> & RequestIdProp) => void,\n  subscribe: (fn: VKBridgeSubscribeHandler) => void\n) {\n  const requestResolver = createRequestResolver();\n\n  // Subscribe to receive a data\n  subscribe((event) => {\n    if (!event.detail || !event.detail.data || typeof event.detail.data !== 'object') {\n      return;\n    }\n\n    // There is no request_id in receive-only events, so we check its existence.\n    if ('request_id' in event.detail.data) {\n      const { request_id: requestId, ...data } = event.detail.data;\n\n      if (requestId) {\n        requestResolver.resolve(requestId, data, (data) => !('error_type' in data));\n      }\n    }\n  });\n\n  return function promisifiedSend<K extends AnyRequestMethodName>(\n    method: K,\n    props: RequestProps<K> & RequestIdProp = {} as RequestProps<K> & RequestIdProp\n  ): Promise<K extends AnyReceiveMethodName ? ReceiveData<K> : void> {\n    return new Promise((resolve, reject) => {\n      const requestId = requestResolver.add({ resolve, reject }, props.request_id);\n\n      sendEvent(method, {\n        ...props,\n        request_id: requestId,\n      });\n    });\n  };\n}\n","import { promisifySend } from './promisifySend';\nimport { VKBridge, VKBridgeSubscribeHandler, AnyRequestMethodName, RequestProps, RequestIdProp } from './types/bridge';\n\n/** Is the client side runtime environment */\nexport const IS_CLIENT_SIDE = typeof window !== 'undefined';\n\n/** Is the runtime environment an Android app */\nexport const IS_ANDROID_WEBVIEW = Boolean(IS_CLIENT_SIDE && (window as any).AndroidBridge);\n\n/** Is the runtime environment an iOS app */\nexport const IS_IOS_WEBVIEW = Boolean(\n  IS_CLIENT_SIDE &&\n    (window as any).webkit &&\n    (window as any).webkit.messageHandlers &&\n    (window as any).webkit.messageHandlers.VKWebAppClose\n);\n\n/** Is the runtime environment a browser */\nexport const IS_WEB = IS_CLIENT_SIDE && !IS_ANDROID_WEBVIEW && !IS_IOS_WEBVIEW;\n\n/** Is the runtime environment m.vk.com */\nexport const IS_MVK = IS_WEB && /(^\\?|&)vk_platform=mobile_web(&|$)/.test(location.search);\n\n/** Is the runtime environment vk.com */\nexport const IS_DESKTOP_VK = IS_WEB && !IS_MVK;\n\n/** Type of subscribe event */\nexport const EVENT_TYPE = IS_WEB ? 'message' : 'VKWebAppEvent';\n\n/** Methods supported on the desktop */\nexport const DESKTOP_METHODS = [\n  'VKWebAppInit',\n  'VKWebAppGetCommunityAuthToken',\n  'VKWebAppAddToCommunity',\n  'VKWebAppAddToHomeScreenInfo',\n  'VKWebAppClose',\n  'VKWebAppCopyText',\n  'VKWebAppGetUserInfo',\n  'VKWebAppSetLocation',\n  'VKWebAppSendToClient',\n  'VKWebAppGetClientVersion',\n  'VKWebAppGetPhoneNumber',\n  'VKWebAppGetEmail',\n  'VKWebAppGetGroupInfo',\n  'VKWebAppGetGeodata',\n  'VKWebAppGetCommunityToken',\n  'VKWebAppSetTitle',\n  'VKWebAppGetAuthToken',\n  'VKWebAppCallAPIMethod',\n  'VKWebAppJoinGroup',\n  'VKWebAppLeaveGroup',\n  'VKWebAppAllowMessagesFromGroup',\n  'VKWebAppDenyNotifications',\n  'VKWebAppAllowNotifications',\n  'VKWebAppOpenPayForm',\n  'VKWebAppOpenApp',\n  'VKWebAppShare',\n  'VKWebAppShowWallPostBox',\n  'VKWebAppScroll',\n  'VKWebAppShowOrderBox',\n  'VKWebAppShowLeaderBoardBox',\n  'VKWebAppShowInviteBox',\n  'VKWebAppShowRequestBox',\n  'VKWebAppAddToFavorites',\n  'VKWebAppShowCommunityWidgetPreviewBox',\n  'VKWebAppShowStoryBox',\n  'VKWebAppStorageGet',\n  'VKWebAppStorageGetKeys',\n  'VKWebAppStorageSet',\n  'VKWebAppFlashGetInfo',\n  'VKWebAppSubscribeStoryApp',\n  'VKWebAppOpenWallPost',\n  'VKWebAppCheckAllowedScopes',\n  'VKWebAppShowNativeAds',\n\n  // Desktop web specific events\n  ...(IS_DESKTOP_VK ? ['VKWebAppResizeWindow', 'VKWebAppAddToMenu', 'VKWebAppShowSubscriptionBox', 'VKWebAppShowInstallPushBox', 'VKWebAppGetFriends'] : ['VKWebAppShowImages']),\n];\n\n/** Android VK Bridge interface. */\nconst androidBridge: Record<string, (serializedData: string) => void> | undefined = IS_CLIENT_SIDE\n  ? (window as any).AndroidBridge\n  : undefined;\n\n/** iOS VK Bridge interface. */\nconst iosBridge: Record<string, { postMessage?: (data: any) => void }> | undefined = IS_IOS_WEBVIEW\n  ? (window as any).webkit.messageHandlers\n  : undefined;\n\n/**\n * Creates a VK Bridge API that holds functions for interact with runtime\n * environment.\n *\n * @param version Version of the package\n */\nexport function createVKBridge(version: string): VKBridge {\n  /** Current frame id. */\n  let webFrameId: string | undefined = undefined;\n\n  /** List of functions that subscribed on events. */\n  const subscribers: VKBridgeSubscribeHandler[] = [];\n\n  /**\n   * Sends an event to the runtime env. In the case of Android/iOS application\n   * env is the application itself. In the case of the browser, the parent\n   * frame in which the event handlers is located.\n   *\n   * @param method The method (event) name to send\n   * @param [props] Method properties\n   */\n  function send<K extends AnyRequestMethodName>(method: K, props?: RequestProps<K> & RequestIdProp) {\n    // Sending data through Android bridge\n    if (androidBridge && androidBridge[method]) {\n      androidBridge[method](JSON.stringify(props));\n    }\n\n    // Sending data through iOS bridge\n    else if (iosBridge && iosBridge[method] && typeof iosBridge[method].postMessage === 'function') {\n      iosBridge[method].postMessage!(props);\n    }\n\n    // Sending data through web bridge\n    else if (IS_WEB) {\n      parent.postMessage(\n        {\n          handler: method,\n          params: props,\n          type: 'vk-connect',\n          webFrameId,\n          connectVersion: version,\n        },\n        '*'\n      );\n    }\n  }\n\n  /**\n   * Adds an event listener. It will be called any time a data is received.\n   *\n   * @param listener A callback to be invoked on every event receive.\n   */\n  function subscribe(listener: VKBridgeSubscribeHandler) {\n    subscribers.push(listener);\n  }\n\n  /**\n   * Removes an event listener which has been subscribed for event listening.\n   *\n   * @param listener A callback to unsubscribe.\n   */\n  function unsubscribe(listener: VKBridgeSubscribeHandler) {\n    const index = subscribers.indexOf(listener);\n\n    if (index > -1) {\n      subscribers.splice(index, 1);\n    }\n  }\n\n  /**\n   * Checks if a method is supported on runtime platform.\n   *\n   * @param method Method (event) name to check.\n   * @returns Result of checking.\n   */\n  function supports<K extends AnyRequestMethodName>(method: K): boolean {\n    if (IS_ANDROID_WEBVIEW) {\n      // Android support check\n      return !!(androidBridge && typeof androidBridge[method] === 'function');\n    } else if (IS_IOS_WEBVIEW) {\n      // iOS support check\n      return !!(iosBridge && iosBridge[method] && typeof iosBridge[method].postMessage === 'function');\n    } else if (IS_WEB) {\n      // Web support check\n      return DESKTOP_METHODS.indexOf(method) > -1;\n    }\n\n    return false;\n  }\n\n  /**\n   * Checks whether the runtime is a WebView.\n   *\n   * @returns Result of checking.\n   */\n  function isWebView(): boolean {\n    return IS_IOS_WEBVIEW || IS_ANDROID_WEBVIEW;\n  }\n\n  /**\n   * Checks whether the runtime is an iframe.\n   *\n   * @returns Result of checking.\n   */\n  function isIframe(): boolean {\n    return IS_WEB && window.parent !== window;\n  }\n\n  /**\n   * Checks whether the runtime is embedded.\n   *\n   * @returns Result of checking.\n   */\n  function isEmbedded(): boolean {\n    return isWebView() || isIframe();\n  }\n\n  /**\n   * Checks whether the runtime is standalone.\n   *\n   * @returns Result of checking.\n   */\n  function isStandalone(): boolean {\n    return !isEmbedded();\n  }\n\n  // Subscribes to listening messages from a runtime for calling each\n  // subscribed event listener.\n  if (typeof window !== 'undefined' && 'addEventListener' in window) {\n    window.addEventListener(EVENT_TYPE, (event: any) => {\n      if (IS_IOS_WEBVIEW || IS_ANDROID_WEBVIEW) {\n        // If it's webview\n        return [...subscribers].map((fn) => fn.call(null, event));\n      } else if (IS_WEB && event && event.data) {\n        // If it's web\n        const { type, data, frameId } = event.data;\n\n        if (type && type === 'VKWebAppSettings') {\n          webFrameId = frameId;\n        } else {\n          [...subscribers].map((fn) => fn({ detail: { type, data } }));\n        }\n      }\n    });\n  }\n\n  /**\n   * Enhanced send functions for the ability to receive response data in\n   * the Promise object.\n   */\n  const sendPromise = promisifySend(send, subscribe);\n\n  return {\n    send: sendPromise,\n    sendPromise,\n    subscribe,\n    unsubscribe,\n    supports,\n    isWebView,\n    isIframe,\n    isEmbedded,\n    isStandalone,\n  };\n}\n","/**\n * Creates the CustomEvent polyfill. VK apps use the CustomEvent for transfer\n * data.\n */\nexport function createCustomEventPolyfill() {\n  function CustomEvent<T>(typeArg: string, eventInitDict?: CustomEventInit<T>): CustomEvent<T> {\n    const params = eventInitDict || { bubbles: false, cancelable: false, detail: undefined };\n\n    const evt = document.createEvent('CustomEvent');\n    evt.initCustomEvent(typeArg, !!params.bubbles, !!params.cancelable, params.detail);\n\n    return evt;\n  }\n\n  CustomEvent.prototype = Event.prototype;\n\n  return CustomEvent;\n}\n","import { VKBridge, VKBridgeSend } from './types/bridge';\nimport { Middleware, MiddlewareAPI } from './types/middleware';\n\n/**\n * Creates the VK Bridge enhancer that applies middleware to the `send`\n * method. This is handy for a variety of task such as logging every sent\n * event.\n *\n * @param middlewares The middleware chain to be applied.\n * @returns The VK Bridge enhancer applying the middleware.\n */\nexport function applyMiddleware(...middlewares: Array<Middleware | undefined | null>): (bridge: VKBridge) => VKBridge {\n  if (middlewares.includes(undefined) || middlewares.includes(null)) {\n    return applyMiddleware(...middlewares.filter((item): item is Middleware => typeof item === 'function'));\n  }\n\n  return (bridge) => {\n    if (middlewares.length === 0) {\n      return bridge;\n    }\n\n    let send: VKBridgeSend = () => {\n      throw new Error(\n        'Sending events while constructing your middleware is not allowed. ' +\n          'Other middleware would not be applied to this send.'\n      );\n    };\n\n    const middlewareAPI: MiddlewareAPI = {\n      subscribe: bridge.subscribe,\n      send: (...args) => bridge.send(...args),\n    };\n\n    const chain = middlewares\n      .filter((item): item is Middleware => typeof item === 'function')\n      .map((middleware) => middleware(middlewareAPI)) //\n      .reduce((a, b) => (send) => a(b(send)));\n\n    send = chain(bridge.send);\n\n    return {\n      ...bridge,\n      send,\n    };\n  };\n}\n","import { createVKBridge } from './bridge';\nimport { createCustomEventPolyfill } from './custom-event';\nimport { version } from '../package.json';\nimport './custom-event';\n\n// Applying CustomEvent polyfill\nif (typeof window !== 'undefined' && !window.CustomEvent) {\n  (window as any).CustomEvent = createCustomEventPolyfill();\n}\n\n// VK Bridge API\nconst bridge = createVKBridge(version);\n\n// Export typings\nexport * from './types/data';\nexport * from './types/bridge';\nexport * from './types/middleware';\nexport * from './types/deprecated';\n\nexport { applyMiddleware } from './applyMiddleware';\nexport { bridge as default };\n"],"names":["createCounter","current","next","this","createRequestResolver","counter","promiseControllers","add","controller","customId","id","resolve","requestId","data","isSuccess","requestPromise","reject","promisifySend","sendEvent","subscribe","requestResolver","event","detail","_a","method","props","Promise","request_id","IS_CLIENT_SIDE","window","IS_ANDROID_WEBVIEW","Boolean","AndroidBridge","IS_IOS_WEBVIEW","webkit","messageHandlers","VKWebAppClose","IS_WEB","IS_MVK","test","location","search","IS_DESKTOP_VK","EVENT_TYPE","DESKTOP_METHODS","androidBridge","undefined","iosBridge","createVKBridge","version","webFrameId","subscribers","listener","push","isWebView","isIframe","parent","isEmbedded","addEventListener","__spreadArrays","map","fn","call","type_1","data_1","frameId","type","sendPromise","JSON","stringify","postMessage","handler","params","connectVersion","send","unsubscribe","index","indexOf","splice","supports","isStandalone","createCustomEventPolyfill","CustomEvent","typeArg","eventInitDict","bubbles","cancelable","evt","document","createEvent","initCustomEvent","prototype","Event","applyMiddleware","_i","middlewares","includes","filter","item","bridge","length","middlewareAPI","args","middleware","reduce","a","b","chain"],"mappings":"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"}