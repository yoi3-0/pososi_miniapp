{"ast":null,"code":"!function (e, n) {\n  \"object\" == typeof exports && \"undefined\" != typeof module ? n(exports) : \"function\" == typeof define && define.amd ? define([\"exports\"], n) : n((e = e || self).vkBridge = {});\n}(this, function (e) {\n  \"use strict\";\n\n  var a = function () {\n    return (a = Object.assign || function (e) {\n      for (var n, t = 1, o = arguments.length; t < o; t++) for (var r in n = arguments[t]) Object.prototype.hasOwnProperty.call(n, r) && (e[r] = n[r]);\n\n      return e;\n    }).apply(this, arguments);\n  };\n\n  function u() {\n    for (var e = 0, n = 0, t = arguments.length; n < t; n++) e += arguments[n].length;\n\n    var o = Array(e),\n        r = 0;\n\n    for (n = 0; n < t; n++) for (var p = arguments[n], i = 0, a = p.length; i < a; i++, r++) o[r] = p[i];\n\n    return o;\n  }\n\n  function d(p, e) {\n    var o,\n        r,\n        i = (o = {\n      current: 0,\n      next: function () {\n        return ++this.current;\n      }\n    }, r = {}, {\n      add: function (e, n) {\n        var t = null != n ? n : o.next();\n        return r[t] = e, t;\n      },\n      resolve: function (e, n, t) {\n        var o = r[e];\n        o && (t(n) ? o.resolve(n) : o.reject(n), r[e] = null);\n      }\n    });\n    return e(function (e) {\n      if (e.detail && e.detail.data && \"object\" == typeof e.detail.data && \"request_id\" in e.detail.data) {\n        var n = e.detail.data,\n            t = n.request_id,\n            o = function (e, n) {\n          var t = {};\n\n          for (var o in e) Object.prototype.hasOwnProperty.call(e, o) && n.indexOf(o) < 0 && (t[o] = e[o]);\n\n          if (null != e && \"function\" == typeof Object.getOwnPropertySymbols) {\n            var r = 0;\n\n            for (o = Object.getOwnPropertySymbols(e); r < o.length; r++) n.indexOf(o[r]) < 0 && Object.prototype.propertyIsEnumerable.call(e, o[r]) && (t[o[r]] = e[o[r]]);\n          }\n\n          return t;\n        }(n, [\"request_id\"]);\n\n        t && i.resolve(t, o, function (e) {\n          return !(\"error_type\" in e);\n        });\n      }\n    }), function (o, r) {\n      return void 0 === r && (r = {}), new Promise(function (e, n) {\n        var t = i.add({\n          resolve: e,\n          reject: n\n        }, r.request_id);\n        p(o, a(a({}, r), {\n          request_id: t\n        }));\n      });\n    };\n  }\n\n  var n = \"undefined\" != typeof window,\n      s = Boolean(n && window.AndroidBridge),\n      f = Boolean(n && window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.VKWebAppClose),\n      l = n && !s && !f,\n      t = l && /(^\\?|&)vk_platform=mobile_web(&|$)/.test(location.search),\n      b = l ? \"message\" : \"VKWebAppEvent\",\n      c = u([\"VKWebAppInit\", \"VKWebAppGetCommunityAuthToken\", \"VKWebAppAddToCommunity\", \"VKWebAppAddToHomeScreenInfo\", \"VKWebAppClose\", \"VKWebAppCopyText\", \"VKWebAppGetUserInfo\", \"VKWebAppSetLocation\", \"VKWebAppSendToClient\", \"VKWebAppGetClientVersion\", \"VKWebAppGetPhoneNumber\", \"VKWebAppGetEmail\", \"VKWebAppGetGroupInfo\", \"VKWebAppGetGeodata\", \"VKWebAppGetCommunityToken\", \"VKWebAppSetTitle\", \"VKWebAppGetAuthToken\", \"VKWebAppCallAPIMethod\", \"VKWebAppJoinGroup\", \"VKWebAppLeaveGroup\", \"VKWebAppAllowMessagesFromGroup\", \"VKWebAppDenyNotifications\", \"VKWebAppAllowNotifications\", \"VKWebAppOpenPayForm\", \"VKWebAppOpenApp\", \"VKWebAppShare\", \"VKWebAppShowWallPostBox\", \"VKWebAppScroll\", \"VKWebAppShowOrderBox\", \"VKWebAppShowLeaderBoardBox\", \"VKWebAppShowInviteBox\", \"VKWebAppShowRequestBox\", \"VKWebAppAddToFavorites\", \"VKWebAppShowCommunityWidgetPreviewBox\", \"VKWebAppShowStoryBox\", \"VKWebAppStorageGet\", \"VKWebAppStorageGetKeys\", \"VKWebAppStorageSet\", \"VKWebAppFlashGetInfo\", \"VKWebAppSubscribeStoryApp\", \"VKWebAppOpenWallPost\", \"VKWebAppCheckAllowedScopes\", \"VKWebAppShowNativeAds\"], l && !t ? [\"VKWebAppResizeWindow\", \"VKWebAppAddToMenu\", \"VKWebAppShowSubscriptionBox\", \"VKWebAppShowInstallPushBox\", \"VKWebAppGetFriends\"] : [\"VKWebAppShowImages\"]),\n      A = n ? window.AndroidBridge : void 0,\n      w = f ? window.webkit.messageHandlers : void 0;\n\n  function o(e, n) {\n    var t = n || {\n      bubbles: !1,\n      cancelable: !1,\n      detail: void 0\n    },\n        o = document.createEvent(\"CustomEvent\");\n    return o.initCustomEvent(e, !!t.bubbles, !!t.cancelable, t.detail), o;\n  }\n\n  \"undefined\" == typeof window || window.CustomEvent || (window.CustomEvent = (o.prototype = Event.prototype, o));\n\n  var r = function (t) {\n    var p = void 0,\n        i = [];\n\n    function e(e) {\n      i.push(e);\n    }\n\n    function n() {\n      return f || s;\n    }\n\n    function o() {\n      return l && window.parent !== window;\n    }\n\n    function r() {\n      return n() || o();\n    }\n\n    \"undefined\" != typeof window && \"addEventListener\" in window && window.addEventListener(b, function (n) {\n      if (f || s) return u(i).map(function (e) {\n        return e.call(null, n);\n      });\n\n      if (l && n && n.data) {\n        var e = n.data,\n            t = e.type,\n            o = e.data,\n            r = e.frameId;\n        t && \"VKWebAppSettings\" === t ? p = r : u(i).map(function (e) {\n          return e({\n            detail: {\n              type: t,\n              data: o\n            }\n          });\n        });\n      }\n    });\n    var a = d(function (e, n) {\n      A && A[e] ? A[e](JSON.stringify(n)) : w && w[e] && \"function\" == typeof w[e].postMessage ? w[e].postMessage(n) : l && parent.postMessage({\n        handler: e,\n        params: n,\n        type: \"vk-connect\",\n        webFrameId: p,\n        connectVersion: t\n      }, \"*\");\n    }, e);\n    return {\n      send: a,\n      sendPromise: a,\n      subscribe: e,\n      unsubscribe: function (e) {\n        var n = i.indexOf(e);\n        -1 < n && i.splice(n, 1);\n      },\n      supports: function (e) {\n        return s ? !(!A || \"function\" != typeof A[e]) : f ? !(!w || !w[e] || \"function\" != typeof w[e].postMessage) : l && -1 < c.indexOf(e);\n      },\n      isWebView: n,\n      isIframe: o,\n      isEmbedded: r,\n      isStandalone: function () {\n        return !r();\n      }\n    };\n  }(\"2.4.6\");\n\n  e.applyMiddleware = function e() {\n    for (var o = [], n = 0; n < arguments.length; n++) o[n] = arguments[n];\n\n    return o.includes(void 0) || o.includes(null) ? e.apply(void 0, o.filter(function (e) {\n      return \"function\" == typeof e;\n    })) : function (t) {\n      if (0 === o.length) return t;\n      var e,\n          n = {\n        subscribe: t.subscribe,\n        send: function () {\n          for (var e = [], n = 0; n < arguments.length; n++) e[n] = arguments[n];\n\n          return t.send.apply(t, e);\n        }\n      };\n      return e = o.filter(function (e) {\n        return \"function\" == typeof e;\n      }).map(function (e) {\n        return e(n);\n      }).reduce(function (n, t) {\n        return function (e) {\n          return n(t(e));\n        };\n      })(t.send), a(a({}, t), {\n        send: e\n      });\n    };\n  }, e.default = r, Object.defineProperty(e, \"__esModule\", {\n    value: !0\n  });\n});","map":{"version":3,"sources":["../src/promisifySend.ts","../src/bridge.ts","../src/custom-event.ts","../src/index.ts","../src/applyMiddleware.ts"],"names":["current","next","this","counter","promiseControllers","add","controller","customId","id","resolve","requestId","data","isSuccess","requestPromise","reject","promisifySend","sendEvent","subscribe","requestResolver","event","detail","_a","method","props","Promise","request_id","IS_CLIENT_SIDE","window","IS_ANDROID_WEBVIEW","Boolean","AndroidBridge","IS_IOS_WEBVIEW","webkit","messageHandlers","VKWebAppClose","IS_WEB","IS_MVK","test","location","search","EVENT_TYPE","DESKTOP_METHODS","androidBridge","undefined","iosBridge","version","webFrameId","subscribers","JSON","stringify","postMessage","parent","handler","params","type","connectVersion","listener","push","index","indexOf","splice","isWebView","isIframe","isEmbedded","addEventListener","__spreadArrays","map","fn","call","type_1","data_1","frameId","sendPromise","send","unsubscribe","supports","isStandalone","CustomEvent","typeArg","eventInitDict","bubbles","cancelable","evt","document","createEvent","initCustomEvent","prototype","Event","bridge","createVKBridge","applyMiddleware","middlewares","includes","filter","item","length","middlewareAPI","args","middleware","reduce","a","b"],"mappings":"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","sourcesContent":["import {\n  VKBridgeSubscribeHandler,\n  AnyRequestMethodName,\n  RequestProps,\n  RequestIdProp,\n  ReceiveData,\n  AnyReceiveMethodName,\n} from './types/bridge';\n\n/**\n * Creates counter interface.\n */\nfunction createCounter() {\n  return {\n    current: 0,\n    next() {\n      return ++this.current;\n    },\n  };\n}\n\n/**\n * Creates interface for resolving request promises by request id's (or not).\n */\nfunction createRequestResolver() {\n  /**\n   * @prop resolve Resolve function.\n   * @prop reject Reject function.\n   */\n  type PromiseController = {\n    resolve: (value: any) => any;\n    reject: (reason: any) => any;\n  };\n\n  const counter = createCounter();\n  const promiseControllers: Record<number | string, PromiseController | null> = {};\n\n  return {\n    /**\n     * Adds new controller with resolve/reject methods.\n     *\n     * @param controller Object with `resolve` and `reject` functions\n     * @param customId Custom `request_id`\n     * @returns New request id of the added controller.\n     */\n    add(controller: PromiseController, customId?: number | string): number | string {\n      const id = customId != null ? customId : counter.next();\n\n      promiseControllers[id] = controller;\n\n      return id;\n    },\n\n    /**\n     * Resolves/rejects an added promise by request id and the `isSuccess`\n     * predicate.\n     *\n     * @param requestId Request ID.\n     * @param data Data to pass to the resolve- or reject-function.\n     * @param isSuccess Predicate to select the desired function.\n     */\n    resolve<T>(requestId: number | string, data: T, isSuccess: (data: T) => boolean) {\n      const requestPromise = promiseControllers[requestId];\n\n      if (requestPromise) {\n        if (isSuccess(data)) {\n          requestPromise.resolve(data);\n        } else {\n          requestPromise.reject(data);\n        }\n\n        promiseControllers[requestId] = null;\n      }\n    },\n  };\n}\n\n/**\n * Returns send function that returns promises.\n *\n * @param sendEvent Send event function.\n * @param subscribe Subscribe event function.\n * @returns Send function which returns the Promise object.\n */\nexport function promisifySend(\n  sendEvent: <K extends AnyRequestMethodName>(method: K, props?: RequestProps<K> & RequestIdProp) => void,\n  subscribe: (fn: VKBridgeSubscribeHandler) => void\n) {\n  const requestResolver = createRequestResolver();\n\n  // Subscribe to receive a data\n  subscribe((event) => {\n    if (!event.detail || !event.detail.data || typeof event.detail.data !== 'object') {\n      return;\n    }\n\n    // There is no request_id in receive-only events, so we check its existence.\n    if ('request_id' in event.detail.data) {\n      const { request_id: requestId, ...data } = event.detail.data;\n\n      if (requestId) {\n        requestResolver.resolve(requestId, data, (data) => !('error_type' in data));\n      }\n    }\n  });\n\n  return function promisifiedSend<K extends AnyRequestMethodName>(\n    method: K,\n    props: RequestProps<K> & RequestIdProp = {} as RequestProps<K> & RequestIdProp\n  ): Promise<K extends AnyReceiveMethodName ? ReceiveData<K> : void> {\n    return new Promise((resolve, reject) => {\n      const requestId = requestResolver.add({ resolve, reject }, props.request_id);\n\n      sendEvent(method, {\n        ...props,\n        request_id: requestId,\n      });\n    });\n  };\n}\n","import { promisifySend } from './promisifySend';\nimport { VKBridge, VKBridgeSubscribeHandler, AnyRequestMethodName, RequestProps, RequestIdProp } from './types/bridge';\n\n/** Is the client side runtime environment */\nexport const IS_CLIENT_SIDE = typeof window !== 'undefined';\n\n/** Is the runtime environment an Android app */\nexport const IS_ANDROID_WEBVIEW = Boolean(IS_CLIENT_SIDE && (window as any).AndroidBridge);\n\n/** Is the runtime environment an iOS app */\nexport const IS_IOS_WEBVIEW = Boolean(\n  IS_CLIENT_SIDE &&\n    (window as any).webkit &&\n    (window as any).webkit.messageHandlers &&\n    (window as any).webkit.messageHandlers.VKWebAppClose\n);\n\n/** Is the runtime environment a browser */\nexport const IS_WEB = IS_CLIENT_SIDE && !IS_ANDROID_WEBVIEW && !IS_IOS_WEBVIEW;\n\n/** Is the runtime environment m.vk.com */\nexport const IS_MVK = IS_WEB && /(^\\?|&)vk_platform=mobile_web(&|$)/.test(location.search);\n\n/** Is the runtime environment vk.com */\nexport const IS_DESKTOP_VK = IS_WEB && !IS_MVK;\n\n/** Type of subscribe event */\nexport const EVENT_TYPE = IS_WEB ? 'message' : 'VKWebAppEvent';\n\n/** Methods supported on the desktop */\nexport const DESKTOP_METHODS = [\n  'VKWebAppInit',\n  'VKWebAppGetCommunityAuthToken',\n  'VKWebAppAddToCommunity',\n  'VKWebAppAddToHomeScreenInfo',\n  'VKWebAppClose',\n  'VKWebAppCopyText',\n  'VKWebAppGetUserInfo',\n  'VKWebAppSetLocation',\n  'VKWebAppSendToClient',\n  'VKWebAppGetClientVersion',\n  'VKWebAppGetPhoneNumber',\n  'VKWebAppGetEmail',\n  'VKWebAppGetGroupInfo',\n  'VKWebAppGetGeodata',\n  'VKWebAppGetCommunityToken',\n  'VKWebAppSetTitle',\n  'VKWebAppGetAuthToken',\n  'VKWebAppCallAPIMethod',\n  'VKWebAppJoinGroup',\n  'VKWebAppLeaveGroup',\n  'VKWebAppAllowMessagesFromGroup',\n  'VKWebAppDenyNotifications',\n  'VKWebAppAllowNotifications',\n  'VKWebAppOpenPayForm',\n  'VKWebAppOpenApp',\n  'VKWebAppShare',\n  'VKWebAppShowWallPostBox',\n  'VKWebAppScroll',\n  'VKWebAppShowOrderBox',\n  'VKWebAppShowLeaderBoardBox',\n  'VKWebAppShowInviteBox',\n  'VKWebAppShowRequestBox',\n  'VKWebAppAddToFavorites',\n  'VKWebAppShowCommunityWidgetPreviewBox',\n  'VKWebAppShowStoryBox',\n  'VKWebAppStorageGet',\n  'VKWebAppStorageGetKeys',\n  'VKWebAppStorageSet',\n  'VKWebAppFlashGetInfo',\n  'VKWebAppSubscribeStoryApp',\n  'VKWebAppOpenWallPost',\n  'VKWebAppCheckAllowedScopes',\n  'VKWebAppShowNativeAds',\n\n  // Desktop web specific events\n  ...(IS_DESKTOP_VK ? ['VKWebAppResizeWindow', 'VKWebAppAddToMenu', 'VKWebAppShowSubscriptionBox', 'VKWebAppShowInstallPushBox', 'VKWebAppGetFriends'] : ['VKWebAppShowImages']),\n];\n\n/** Android VK Bridge interface. */\nconst androidBridge: Record<string, (serializedData: string) => void> | undefined = IS_CLIENT_SIDE\n  ? (window as any).AndroidBridge\n  : undefined;\n\n/** iOS VK Bridge interface. */\nconst iosBridge: Record<string, { postMessage?: (data: any) => void }> | undefined = IS_IOS_WEBVIEW\n  ? (window as any).webkit.messageHandlers\n  : undefined;\n\n/**\n * Creates a VK Bridge API that holds functions for interact with runtime\n * environment.\n *\n * @param version Version of the package\n */\nexport function createVKBridge(version: string): VKBridge {\n  /** Current frame id. */\n  let webFrameId: string | undefined = undefined;\n\n  /** List of functions that subscribed on events. */\n  const subscribers: VKBridgeSubscribeHandler[] = [];\n\n  /**\n   * Sends an event to the runtime env. In the case of Android/iOS application\n   * env is the application itself. In the case of the browser, the parent\n   * frame in which the event handlers is located.\n   *\n   * @param method The method (event) name to send\n   * @param [props] Method properties\n   */\n  function send<K extends AnyRequestMethodName>(method: K, props?: RequestProps<K> & RequestIdProp) {\n    // Sending data through Android bridge\n    if (androidBridge && androidBridge[method]) {\n      androidBridge[method](JSON.stringify(props));\n    }\n\n    // Sending data through iOS bridge\n    else if (iosBridge && iosBridge[method] && typeof iosBridge[method].postMessage === 'function') {\n      iosBridge[method].postMessage!(props);\n    }\n\n    // Sending data through web bridge\n    else if (IS_WEB) {\n      parent.postMessage(\n        {\n          handler: method,\n          params: props,\n          type: 'vk-connect',\n          webFrameId,\n          connectVersion: version,\n        },\n        '*'\n      );\n    }\n  }\n\n  /**\n   * Adds an event listener. It will be called any time a data is received.\n   *\n   * @param listener A callback to be invoked on every event receive.\n   */\n  function subscribe(listener: VKBridgeSubscribeHandler) {\n    subscribers.push(listener);\n  }\n\n  /**\n   * Removes an event listener which has been subscribed for event listening.\n   *\n   * @param listener A callback to unsubscribe.\n   */\n  function unsubscribe(listener: VKBridgeSubscribeHandler) {\n    const index = subscribers.indexOf(listener);\n\n    if (index > -1) {\n      subscribers.splice(index, 1);\n    }\n  }\n\n  /**\n   * Checks if a method is supported on runtime platform.\n   *\n   * @param method Method (event) name to check.\n   * @returns Result of checking.\n   */\n  function supports<K extends AnyRequestMethodName>(method: K): boolean {\n    if (IS_ANDROID_WEBVIEW) {\n      // Android support check\n      return !!(androidBridge && typeof androidBridge[method] === 'function');\n    } else if (IS_IOS_WEBVIEW) {\n      // iOS support check\n      return !!(iosBridge && iosBridge[method] && typeof iosBridge[method].postMessage === 'function');\n    } else if (IS_WEB) {\n      // Web support check\n      return DESKTOP_METHODS.indexOf(method) > -1;\n    }\n\n    return false;\n  }\n\n  /**\n   * Checks whether the runtime is a WebView.\n   *\n   * @returns Result of checking.\n   */\n  function isWebView(): boolean {\n    return IS_IOS_WEBVIEW || IS_ANDROID_WEBVIEW;\n  }\n\n  /**\n   * Checks whether the runtime is an iframe.\n   *\n   * @returns Result of checking.\n   */\n  function isIframe(): boolean {\n    return IS_WEB && window.parent !== window;\n  }\n\n  /**\n   * Checks whether the runtime is embedded.\n   *\n   * @returns Result of checking.\n   */\n  function isEmbedded(): boolean {\n    return isWebView() || isIframe();\n  }\n\n  /**\n   * Checks whether the runtime is standalone.\n   *\n   * @returns Result of checking.\n   */\n  function isStandalone(): boolean {\n    return !isEmbedded();\n  }\n\n  // Subscribes to listening messages from a runtime for calling each\n  // subscribed event listener.\n  if (typeof window !== 'undefined' && 'addEventListener' in window) {\n    window.addEventListener(EVENT_TYPE, (event: any) => {\n      if (IS_IOS_WEBVIEW || IS_ANDROID_WEBVIEW) {\n        // If it's webview\n        return [...subscribers].map((fn) => fn.call(null, event));\n      } else if (IS_WEB && event && event.data) {\n        // If it's web\n        const { type, data, frameId } = event.data;\n\n        if (type && type === 'VKWebAppSettings') {\n          webFrameId = frameId;\n        } else {\n          [...subscribers].map((fn) => fn({ detail: { type, data } }));\n        }\n      }\n    });\n  }\n\n  /**\n   * Enhanced send functions for the ability to receive response data in\n   * the Promise object.\n   */\n  const sendPromise = promisifySend(send, subscribe);\n\n  return {\n    send: sendPromise,\n    sendPromise,\n    subscribe,\n    unsubscribe,\n    supports,\n    isWebView,\n    isIframe,\n    isEmbedded,\n    isStandalone,\n  };\n}\n","/**\n * Creates the CustomEvent polyfill. VK apps use the CustomEvent for transfer\n * data.\n */\nexport function createCustomEventPolyfill() {\n  function CustomEvent<T>(typeArg: string, eventInitDict?: CustomEventInit<T>): CustomEvent<T> {\n    const params = eventInitDict || { bubbles: false, cancelable: false, detail: undefined };\n\n    const evt = document.createEvent('CustomEvent');\n    evt.initCustomEvent(typeArg, !!params.bubbles, !!params.cancelable, params.detail);\n\n    return evt;\n  }\n\n  CustomEvent.prototype = Event.prototype;\n\n  return CustomEvent;\n}\n","import { createVKBridge } from './bridge';\nimport { createCustomEventPolyfill } from './custom-event';\nimport { version } from '../package.json';\nimport './custom-event';\n\n// Applying CustomEvent polyfill\nif (typeof window !== 'undefined' && !window.CustomEvent) {\n  (window as any).CustomEvent = createCustomEventPolyfill();\n}\n\n// VK Bridge API\nconst bridge = createVKBridge(version);\n\n// Export typings\nexport * from './types/data';\nexport * from './types/bridge';\nexport * from './types/middleware';\nexport * from './types/deprecated';\n\nexport { applyMiddleware } from './applyMiddleware';\nexport { bridge as default };\n","import { VKBridge, VKBridgeSend } from './types/bridge';\nimport { Middleware, MiddlewareAPI } from './types/middleware';\n\n/**\n * Creates the VK Bridge enhancer that applies middleware to the `send`\n * method. This is handy for a variety of task such as logging every sent\n * event.\n *\n * @param middlewares The middleware chain to be applied.\n * @returns The VK Bridge enhancer applying the middleware.\n */\nexport function applyMiddleware(...middlewares: Array<Middleware | undefined | null>): (bridge: VKBridge) => VKBridge {\n  if (middlewares.includes(undefined) || middlewares.includes(null)) {\n    return applyMiddleware(...middlewares.filter((item): item is Middleware => typeof item === 'function'));\n  }\n\n  return (bridge) => {\n    if (middlewares.length === 0) {\n      return bridge;\n    }\n\n    let send: VKBridgeSend = () => {\n      throw new Error(\n        'Sending events while constructing your middleware is not allowed. ' +\n          'Other middleware would not be applied to this send.'\n      );\n    };\n\n    const middlewareAPI: MiddlewareAPI = {\n      subscribe: bridge.subscribe,\n      send: (...args) => bridge.send(...args),\n    };\n\n    const chain = middlewares\n      .filter((item): item is Middleware => typeof item === 'function')\n      .map((middleware) => middleware(middlewareAPI)) //\n      .reduce((a, b) => (send) => a(b(send)));\n\n    send = chain(bridge.send);\n\n    return {\n      ...bridge,\n      send,\n    };\n  };\n}\n"]},"metadata":{},"sourceType":"script"}